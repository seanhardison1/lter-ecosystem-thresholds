---
title: "Simulating GAMMs"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(mgcv)
library(mgcViz)
library(nlme)
library(tidyverse)
library(ecodata)
library(forecast)
library(patchwork)
library(magrittr)
library(itsadug)
```

#### Model time series to simulate from
Acquire and process annual primary production data from the Northeast Shelf Large Marine Ecosystem. 

```{r}
ppd <- chl_pp %>% 
  filter(Var %in%
           c("ANNUAL_PPD_MEDIAN SeaWiFS BERENFELD",
             "ANNUAL_PPD_MEDIAN MODIS-Aqua BERENFELD")) 
```

Do the same for chlorophyll *a* data.

```{r}
chl <- chl_pp %>% 
  filter(Var %in%
           c("ANNUAL_CHLOR_A_MEDIAN SeaWiFS PAN",
             "ANNUAL_CHLOR_A_MEDIAN MODIS-Aqua PAN"))
```

We'll also need to pull SST data. The SST data identified below is the average annual SST for the whole Northeast Shelf. It was extracted from the NOAA extended reconstructed sea surface temperature data set (ERSST V5).

```{r}
sst <- ecodata::long_term_sst %>% 
  mutate(id = 1:length(Time))
```


#### Identify time series structures

Using `forecast::auto.arima()`, we model the ARIMA structure of chlorophyll *a* and primary production time series. We can then simulate from the resulting arima models using the `sim.df` defined function below.

```{r}
#SST is non-stationary and trend magnitudes vary across latitudes. We generalize simulations of SST by assuming AR1 error structure and varying trend strength, centered around trend derived from NES SST
make_sim <- function(df, b0_adjust = rnorm(1)*0.1, b_adjust = 0, n = 21, Site){
  id <- 1:length(df$Time)
  mod <- gls(Value ~ id, data = df, corr = corAR1(form = ~id))
  b1 <- coef(mod)[2]
  b0 <- coef(mod)[1]
  sim <- data.frame(Value = b0 + b0_adjust + 1:n * (b1 + b_adjust) + rnorm(n))
  return(sim)
}
```

#### Simulate

```{r}
#Simulate SST 8 times, with slope varying from what was calcuated for the NE shelf by about ~ 0.03 degree/year intervals. Starting at estimated_slope - 0.04 degrees/year and ending at estimated_slope + 0.04 degrees/year.
sstsimlist <- lapply(seq(-0.04, 0.04, length.out = 8), make_sim, df = sst)
sst.df <- do.call(rbind.data.frame, sstsimlist) %>% 
  mutate(Site = factor(rep(paste("Site",letters[1:8]), each = 21)),
         Time = rep(1:21, 8)) %>% 
  dplyr::rename(SST = Value)

#Fit GLS models to CHL/PP time series and simulate
ppsimlist <- lapply(seq(-0.02, 1, length.out = 8), make_sim, df = ppd)
pp.df <- do.call(rbind.data.frame, ppsimlist) %>% 
  mutate(Site = factor(rep(paste("Site",letters[1:8]), each = 21)),
         Time = rep(1:21, 8)) %>% 
  dplyr::rename(PP = Value)

chlsimlist <- lapply(seq(-0.02, 0.04, length.out = 8), make_sim, df = chl)
chl.df <- do.call(rbind.data.frame, chlsimlist) %>% 
  mutate(Site = factor(rep(paste("Site",letters[1:8]), each = 21)),
         Time = rep(1:21, 8)) %>% 
  dplyr::rename(CHL = Value)
```

#### Fit GAMMs to examine pressure-response relationship across "ecosystems"

```{r}
pp_merged <- sst.df %>% 
  left_join(.,pp.df, by = c("Site","Time"))
  
chl_merged <- sst.df %>% 
  left_join(.,chl.df, by = c("Site","Time"))
  

mixed_pp <- gam(PP ~ s(SST) + s(SST,Site, bs ='re'),
                  data = pp_merged,method = "REML")

plot_smooth(mixed_pp, view = "SST", plot_all = "Site")
```

